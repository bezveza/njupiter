#summary Documentation for nJupiter.DataAccess.Ldap

<wiki:toc max_depth="2" />

= nJupiter.DataAccess.Ldap =

Component containing a generic MembershipProvider and RoleProvider for LDAP . These providers has been successfully tested with Microsoft Active Directory, Novell eDirectory, IBM Tivoli Directory Server and Lotus Domino but shall probably work with any type of LDAP-server such as OpenLDAP, 389 Directory Server, OpenDS / OpenDJ, Apache DS and Oracle Internet Directory (if you are using these providers with any of the server not listed as tested, please contact with status regaring if they successfully work or not).

The component also contain facades and abstractions for System.DirectoryServices namespace and a parser for distinguished names.

== History and Purpose ==

A few years ago [http://code.google.com/u/martin.odhelius/ I] started to work in a project that had the goal to use a CMS that were using .NET's MembershipProvider and RoleProvider architecture for authentication and user management. The customer that would use the CMS solution used an IBM Tivoli LDAP Directory Server and first I thought that would not be any problems since I was prety sure that it would exist a LDAP MembershipProvider and RoleProvider in the .NET framework, but to my surprise it didn't! Then I started to look around the web for alternatives but I didn't find any LDAP MembershipProvider and RoleProvider anywhere so I decided to write my own. My aims was to write a generic LDAP provider that should work both with my internal Active Directory test server and together with the customer's Tivoli server or with any other LDAP server out there, the result was nJupiter.DataAccess.Ldap.
 
== How to set up nJupiter.DataAccess.Ldap ==

You can install nJupiter.DataAccess.Ldap via NuGet. The NuGet package do not include any config though so you will have to activate the providers in your web.config and also add configuration for your LDAP-server before it will work.

nJupiter.DataAccess.Ldap is using [nJupiterConfiguration nJupiter.Configuration] which will install together with nJupiter.DataAccess.Ldap if you install it via NuGet.
For more information about how to configure and set up nJupiter.Configuration please refer to [nJupiterConfiguration#How_to_set_up_nJupiter.Configuration this page]. The config file containing the LDAP server config shall be named nJupiter.DataAccess.Ldap.config and placed anywhere where nJupiter.Configuration can read it. You can find an example file with  configurations for different LDAP servers [http://code.google.com/p/njupiter/source/browse/trunk/Development/Shared%20Resources/Config/nJupiter.DataAccess.Ldap.config here]. Read more how to configure the component [nJupiterConfiguration#How_to_configure_nJupiter._.Ldap here]

When you have added configuration for you LDAP server you are ready to turn the providers on in web.config. You do this in the membership and roleManager elements beneath system.web. Here is an example:

{{{
<system.web>
   <membership defaultProvider="LdapMembershipProvider">
      <providers>
         <clear/>
         <add name="LdapMembershipProvider"
              ldapServer="Tivoli"
              type="nJupiter.DataAccess.Ldap.LdapMembershipProvider,nJupiter.DataAccess.Ldap" />
      </providers>
   </membership>
   <roleManager enabled="true" defaultProvider="LdapRoleProvider" cacheRolesInCookie="true">
      <providers>
         <clear/>
         <add name="LdapRoleProvider"
              ldapServer="Tivoli"
              type="nJupiter.DataAccess.Ldap.LdapRoleProvider,nJupiter.DataAccess.Ldap" />
      </providers>
   </roleManager>
</system.web>
}}}

The ldapServer attribute tells which ldap configuration in nJupiter.DataAccess.Ldap.config to use, if this attribute is left out the configuration with the default="true" attribute will be used. If you need more information how to configure MembershipProviders and RoleProviders you can find it here:

  * [http://msdn.microsoft.com/en-us/library/ff648345.aspx How To: Use Membership in ASP.NET 2.0]
  * [http://msdn.microsoft.com/en-us/library/ff647401.aspx How To: Use Role Manager in ASP.NET 2.0]
  * [http://msdn.microsoft.com/en-us/library/1b9hw62f.aspx membership Element (ASP.NET Settings Schema)]
  * [http://msdn.microsoft.com/en-us/library/ms164660.aspx roleManager Element (ASP.NET Settings Schema)]
 
== How to configure nJupiter.DataAccess.Ldap ==

The nJupiter.DataAccess.Ldap.config config file has to contain an `ldapServers`-element that contain one or more `ldapServer`-elements. The `ldapServer`-element has to have a `value`-attribute that is the name of the server. If you do not specify a name in the `ldapServer`-attribute for your provider in web.config you have to add a `default` attribute set to `true` for any of the `ldapServer`-elements. Here is an example:

{{{
<ldapServer value="MyLdapServer" default="true">
   <!--... server configuration goes here -->
</ldapServer>
}}}

Beneath the `ldapServer`-element you add the configuration for the current server. The first thing you have to do is to define the URL to the LDAP-server. You do this in the `url`-element by setting the `value`-attribute to the URL for the server. This value has to be a fully qualified uri as defined in the [http://www.ietf.org/rfc/rfc2396.txt RFC 2396]. Here is an example:

{{{
<url value="LDAP://ldap.example.org:389/" />
}}}

The next thing you have to do is to define a `username` and `password` to use when the providers authenticating themselves towards the LDAP server. This user have to have read access in the directory. For more information please read more [http://msdn.microsoft.com/en-us/library/system.directoryservices.directoryentry.username%28v=vs.90%29 here] and [http://msdn.microsoft.com/en-us/library/system.directoryservices.directoryentry.password%28v=vs.90%29 here]. Here is an example:

{{{
<username value="uid=user,ou=people,dc=example,dc=org" />
<password value="password" />
}}}

You can also define the authentication types to use inside the `authenticationTypes`-element. The possible authentication types are `None`, `Secure`, `Encryption`, `SecureSocketsLayer`, `ReadonlyServer`, `Anonymous`, `FastBind`, `Signing`, `Sealing`, `Delegation` and  `ServerBind`. One or more of these values can be defined beneath the `authenticationTypes`-element in one `authenticationType`-element per type. If you do not define any `authenticationTypes`-element the default authentication type will be `None`. Read more about authentication types [http://msdn.microsoft.com/en-us/library/system.directoryservices.authenticationtypes%28v=vs.90%29 here]. Here is an example:

{{{
<authenticationTypes>
   <authenticationType value="SecureSocketsLayer" />
   <authenticationType value="ReadonlyServer" />
</authenticationTypes>
}}}

You can also set a time limit in seconds wich will be the maximum amount of time the server spends when searching for entries in the LDAP server. You do this in the `timeLimit`-element. If you leave this element out the default value will be set to 30 seconds. Here is an example where the time limit is set to 5 seconds:

{{{
<timeLimit value="5" />
}}}

If your server supports [http://www.ietf.org/proceedings/55/I-D/draft-ietf-ldapext-ldapv3-vlv-09.txt Virtual List View] (VLV) it is highly recommended that you enables it by setting the 'virtualListViewSupport'-element to true. If you leave this element out the default vill be false. Without this feature the LdapMembershipProvider will not be able to perform fully and performance wise paging when the `GetAllUsers`-, `FindUsersByName`- and `FindUsersByEmail`-methods is called. Most modern LDAP servers support VLV servers, here is a list of known server that supports VLV:
 
 * IBM Tivoli Directory Server (since 6.2)
 * Microsoft Active Directory (since Windows Server 2003)
 * Novell eDirectory (since 8.8 [http://www.novell.com/support/kb/doc.php?id=7001493 with limitations])
 * OpenLDAP (since 2.4, [http://www.manpagez.com/man/5/slapo-sssvlv/ via overlay])
 * 389 Directory Server
 * OpenDS and OpenDJ

Here is an example how to turn this feature on:

{{{
<virtualListViewSupport value="true" />
}}}

If your server does not support Virtual List View but [http://www.ietf.org/rfc/rfc2891.txt Server Side Sort] you an turn this on by setting the 'propertySortingSupport'-element to true. If you leave this element out the default vill be false. If you are using VLV you can leave this element out though because Server Side Sort is required for VLV to function so in that case the sorting will be performed regardless the setting of this flag. Here is an example how to turn this feature on:

{{{
<propertySortingSupport value="true" />
}}}

You can also define a size limit which will be the maximum number of objects that the server returns in one single search operation. If you leave this element out the default value will be set to 1000. If you set size limit to a value that is larger than the server-determined default of 1000 entries, the server-determined default is used. For better performance when for example a whole set of users, it can be a good idea to keep this value pretty low if your server does not support Virtual List View. If you are using a server that supports VLV it is recommended to leave this element out or to set it to the default value. Here is an example here the size limit is set to a maximum of 100 objects per search:

{{{
<sizeLimit value="100" />
}}}

If your LDAP server does not support Virtual List View it can be a good reason to set the page size that will be used when the client preforms [http://www.ietf.org/rfc/rfc2696.txt Simple Paged Results] which will be the standard paging function if VLV is not used. Please set this value to a lower value than the size limit. The default value is 0, which means that no simple paging will be performed on searches. If you are using a server that supports VLV it is recommended to leave this element out or to set it to the default value. Here is an example where the page size is set to 50 objects:

{{{
<pageSize value="50" />
}}}

If your server supports fetching properties by [http://msdn.microsoft.com/en-us/library/cc223242%28v=prot.13%29.aspx range retrieval] you can turn this feature on by setting the `rangeRetrievalSupport`-element to true. If you leave this element out the default vill be false. It is a good idea to turn this on if your directory contains extremely large membership list (>1000 members), without it the provider can only fetch max 1500 per role when calling the `GetUsersInRole`-method in the LdapRoleProvider.

... More info added soon ...

{{{
<?xml version="1.0" encoding="utf-8" ?>
<configuration>
   <ldapServers>
      <ldapServer value="MyLdapServer" default="true">
         <url value="LDAP://ldap.example.org:389/" />
         <username value="uid=user,ou=people,dc=example,dc=org"/>
         <password value="password"/>
         <authenticationTypes>
            <authenticationType value="None" />
         </authenticationTypes>
         <timeLimit value="5" />
         <sizeLimit value="100" />
         <pageSize value="0" />
         <virtualListViewSupport value="true" />
         <propertySortingSupport value="true" />
         <rangeRetrievalSupport value="true" />
         <allowWildcardSearch value="true" />
         <users>
            <filter value="(objectClass=person)"/>
            <base value="ou=people,dc=example,dc=org" />
            <rdnAttribute value="uid" />
            <rdnInPath value="true" />
            <nameType value="cn" />
            <membershipAttribute value="memberOf" />
            <descriptionAttribute value="cn" />
            <emailAttribute value="mail" />
            <creationDateAttribute value="whenCreated" />
            <lastLoginDateAttribute value="lastLogon" />
            <lastPasswordChangedDateAttribute value="pwdLastSet" />
            <attributes>
               <attribute value="givenName" />
               <attribute value="sn" />
               <attribute value="title" excludeFromNameSearch="true" />
            </attributes>
         </users>
         <groups>
            <filter value="(objectClass=groupOfNames)"/>
            <base value="ou=groups,dc=example,dc=org" />
            <rdnAttribute value="cn" />
            <rdnInPath value="true" />
            <membershipAttribute value="member" />
            <nameType value="cn" />
         </groups>         
      </ldapServer>
   </ldapServers>
</configuration>
}}}

== How to use ==

The LdapMembershipProvider and LdapRoleProvider are working like standard MembershipProviders and RoleProviders, the providers are read only though and does not implement any functionality that writes information to the LDAP server, besides that you shall be able to use without doing anything more that explained in the previous section.

A bonus feature beside the standard provider interface is that the LdapMembershipProvider is able to load LDAP attributes for users besides the standard MembershipUser attributes. Those can be accessible by casting the  MembershipUser to an nJupiter.DataAccess.Ldap.LdapMembershipUser and read the Attributes property.

== Troubleshooting ==

If you get "System.InvalidOperationException: The value for the property Sort cannot be set", try do disabling property sorting by setting the propertySortingSupport to false in [http://code.google.com/p/njupiter/source/browse/trunk/Development/Shared%20Resources/Config/nJupiter.DataAccess.Ldap.config nJupiter.DataAccess.Ldap.config]

If you get "System.InvalidOperationException: The value for the property PageSize cannot be set.", try to disable paging by either removing the pageSize element entirely or by setting its value to 0 in [http://code.google.com/p/njupiter/source/browse/trunk/Development/Shared%20Resources/Config/nJupiter.DataAccess.Ldap.config nJupiter.DataAccess.Ldap.config]

If you get similar exceptions you can also try to turn of the rangeRetrievalSupport by setting its flag to false.

If you get "COMException (0x80005000): Unknown error (0x80005000)" or similar it is probably caused by difference between your authenticationTypes-setting and how your LDAP server is configured. You can read more about how to configure the authenticationTypes [http://msdn.microsoft.com/en-us/library/system.directoryservices.authenticationtypes.aspx here].